{% extends "base.html" %}
{% load static %}

{% block title %}Manage Data - Vet Cardio App{% endblock title %}

{% block extra_head %}
    {# Add styles for modal transition if not already in base #}
    <style>
        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }
    </style>
{% endblock extra_head %}

{% block content %}
    <div id="manage-app" class="container mx-auto px-4 py-8">
        {% csrf_token %}

        <h1 class="text-3xl font-extrabold tracking-tight text-gray-900 mb-8">Data Management</h1>

        {# --- Notification Area (Moved and Restyled) --- #}
        <transition name="fade">
            <div v-if="notificationVisible" :key="notificationMessage + notificationType" {# Key helps reset transition #}
                 class="w-full p-4 mb-6 rounded-md shadow-md border" {# Removed fixed positioning, added mb-6 #}
                 :class="notificationType === 'success' ? 'bg-green-100 border-green-400 text-green-800' : 'bg-red-100 border-red-400 text-red-800'"
                 role="alert">
                 {# Display message directly #}
                 <p>[[ notificationMessage ]]</p>
                 {# Optional: Add a close button if desired #}
                 {# <button @click="notificationVisible = false" class="absolute top-2 right-2 text-lg font-semibold">&times;</button> #}
            </div>
        </transition>
        {# --- End Notification Area --- #}

        <div class="grid grid-cols-1 gap-y-6 sm:grid-cols-2 lg:grid-cols-3 sm:gap-x-6 lg:gap-x-8">

            <!-- Card 1: Import Owners -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <h3 class="text-lg leading-6 font-medium text-teal-600">Import Owners</h3>
                    <p class="mt-2 text-sm text-gray-500">Bulk import owner data from a CSV file.</p>
                    <button @click="openImportModal('owner')" class="mt-3 text-sm font-medium text-white bg-teal-500 hover:bg-teal-600 py-1 px-3 rounded">
                        Import Owners
                    </button>
                </div>
            </div>

            <!-- Card 2: Export Owners -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <h3 class="text-lg leading-6 font-medium text-sky-600">Export Owners</h3>
                    <p class="mt-2 text-sm text-gray-500">Export all owner data to a file.</p>
                    <a href="#" class="mt-3 text-sm font-medium text-sky-500 hover:text-sky-600"> Go to Export &rarr; </a> {# Placeholder link #}
                </div>
            </div>

            <!-- Card 3: Import Patients -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <h3 class="text-lg leading-6 font-medium text-lime-600">Import Patients</h3>
                    <p class="mt-2 text-sm text-gray-500">Bulk import patient data from a file.</p>
                    <button @click="openImportModal('patient')" disabled class="mt-3 text-sm font-medium text-white bg-lime-500 hover:bg-lime-600 py-1 px-3 rounded disabled:opacity-50 disabled:cursor-not-allowed">
                        Import Patients (WIP)
                    </button>
                </div>
            </div>

             <!-- Card 4: Export Patients -->
             <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <h3 class="text-lg leading-6 font-medium text-cyan-600">Export Patients</h3>
                    <p class="mt-2 text-sm text-gray-500">Export all patient data to a file.</p>
                    <a href="#" class="mt-3 text-sm font-medium text-cyan-500 hover:text-cyan-600"> Go to Export &rarr; </a> {# Placeholder link #}
                </div>
            </div>

        </div>

        <!-- == Import Modal == -->
        <transition name="fade">
            <div v-if="showImportModal" ref="importModal" @click="closeModal" @keydown.escape="closeModal" tabindex="-1"
                class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 outline-none">
                <div @click.stop class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 text-center mb-4">Import [[ importType === 'owner' ? 'Owners' : 'Patients' ]]</h3>

                    <div class="space-y-4 px-4">
                        <p class="text-sm text-gray-600">Upload a CSV file to bulk import data. Please ensure your file matches the required format.</p>

                        <div>
                            <strong class="block text-sm font-medium text-gray-700 mb-1">Required Format:</strong>
                            <a :href="templateDownloadUrl" download
                               class="inline-flex items-center px-3 py-1 border border-transparent text-sm leading-4 font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mb-2">
                               Download Template CSV
                            </a>
                            <ul class="list-disc list-inside text-sm text-gray-500 space-y-1">
                                <li v-for="field in requiredFields" :key="field.name">
                                    <code class="bg-gray-200 px-1 rounded">[[ field.name ]]</code>
                                    <span v-if="field.required" class="text-red-600 font-semibold"> (Required)</span>
                                    <span v-else> (Optional)</span>
                                    - <span class="text-xs italic">([[ field.type ]])</span>
                                </li>
                            </ul>
                        </div>

                        {# This is the correct styled input #}
                        <div>
                             <label for="file-upload" class="block text-sm font-medium text-gray-700">Select CSV File:</label>
                             <input id="file-upload" name="file-upload" type="file" ref="fileInput"
                                    @change="handleFileChange"
                                    accept=".csv" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        </div>

                        <!-- Validation Errors -->
                        <div v-if="validationError" class="mt-2 text-sm text-red-600 bg-red-100 p-3 rounded">
                            <p><strong>Error:</strong> [[ validationError ]]</p>
                        </div>

                         <!-- Preview Section -->
                        <div v-if="previewData.headers.length > 0">
                            <h4 class="text-md font-medium text-gray-800 mb-2">File Preview (Showing first [[ previewData.rows.length ]] of [[ totalCsvRecords ]] total records):</h4>
                            <div class="overflow-x-auto max-h-60 border border-gray-200 rounded">
                                <table class="min-w-full divide-y divide-gray-200 text-xs">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th v-for="header in previewData.headers" :key="header" scope="col" class="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">[[ header ]]</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr v-for="(row, index) in previewData.rows" :key="index">
                                            <td v-for="(cell, cellIndex) in row" :key="cellIndex" class="px-4 py-2 whitespace-nowrap">[[ cell ]]</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>

                    <div class="items-center px-4 py-3 mt-4 text-right border-t border-gray-200">
                         <button @click="confirmImport" :disabled="!canImport || isImporting"
                                class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            [[ isImporting ? 'Importing...' : 'Import Data' ]]
                        </button>
                        <button @click="closeModal"
                                class="ml-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </transition>
    </div>
{% endblock content %}

{% block scripts %}
<script src="https://unpkg.com/vue@3"></script>
<script>
    const manageApp = Vue.createApp({
        data() {
            return {
                showImportModal: false,
                importType: null, // 'owner' or 'patient'
                fileToImport: null,
                validationError: null,
                previewData: { headers: [], rows: [] },
                totalCsvRecords: 0,
                canImport: false,
                isImporting: false,
                csrfToken: '',
                // Notification state
                notificationVisible: false,
                notificationMessage: '',
                notificationType: 'success', // 'success' or 'error'
                notificationTimeout: null, // To store setTimeout ID
                // Define fields for display
                ownerFields: [
                    { name: 'last_name', type: 'Text', required: true },
                    { name: 'first_name', type: 'Text', required: false },
                    { name: 'email', type: 'Email', required: false },
                    { name: 'telephone', type: 'Text', required: false },
                    { name: 'address', type: 'Text', required: false },
                    { name: 'comments', type: 'Text', required: false },
                    { name: 'created_at', type: 'DateTime (YYYY-MM-DD HH:MM:SS)', required: false },
                ],
                patientFields: [ /* Add when patient model exists */ ],
            }
        },
        delimiters: [ '[[', ']]' ],
        computed: {
            requiredFields() {
                return this.importType === 'owner' ? this.ownerFields : this.patientFields;
            },
            templateDownloadUrl() {
                // We'll create this URL in Django later
                return this.importType === 'owner' ? '{% url "owner-import-template" %}' : '#';
            }
        },
        mounted() {
            this.csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        },
        methods: {
            resetImportState() {
                this.fileToImport = null;
                this.validationError = null;
                this.previewData = { headers: [], rows: [] };
                this.totalCsvRecords = 0;
                this.canImport = false;
                this.isImporting = false;
            },
            openImportModal(type) {
                this.resetImportState();
                if (this.$refs.fileInput) {
                    this.$refs.fileInput.value = '';
                }
                this.importType = type;
                this.showImportModal = true;
                this.$nextTick(() => { this.$refs.importModal?.focus(); });
            },
            closeModal() {
                this.showImportModal = false;
                this.resetImportState();
                if (this.$refs.fileInput) {
                    this.$refs.fileInput.value = '';
                }
            },
            handleFileChange(event) {
                this.validationError = null;
                this.previewData = { headers: [], rows: [] };
                this.totalCsvRecords = 0;
                this.canImport = false;

                setTimeout(() => {
                    const fileInput = this.$refs.fileInput;

                    if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                        this.fileToImport = null;
                        return;
                    }
                    const file = fileInput.files[0];

                    if (!file.name.toLowerCase().endsWith('.csv')) {
                        this.validationError = 'Invalid file type. Please upload a .csv file.';
                        this.fileToImport = null;
                        return;
                    }

                    this.fileToImport = file;
                    this.validateAndPreviewFile();
                }, 0);
            },
            async validateAndPreviewFile() {
                if (!this.fileToImport) return;

                const formData = new FormData();
                formData.append('file', this.fileToImport);
                formData.append('import_type', this.importType);

                const previewUrl = '{% url "owner-import-preview" %}';

                this.totalCsvRecords = 0;
                try {
                    const response = await fetch(previewUrl, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': this.csrfToken
                        },
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        this.previewData = data.preview;
                        this.totalCsvRecords = data.total_records || 0;
                        this.canImport = true;
                        this.validationError = null;
                    } else {
                        this.validationError = data.error || 'Failed to validate or preview file.';
                        this.canImport = false;
                        this.previewData = { headers: [], rows: [] };
                        this.totalCsvRecords = 0;
                    }
                } catch (error) {
                    console.error("Preview request failed:", error);
                    this.validationError = 'An error occurred while processing the file.';
                    this.canImport = false;
                    this.previewData = { headers: [], rows: [] };
                    this.totalCsvRecords = 0;
                }
            },
            showNotification(message, type = 'success') {
                this.notificationMessage = message;
                this.notificationType = type;
                this.notificationVisible = true;

                if (this.notificationTimeout) {
                    clearTimeout(this.notificationTimeout);
                }
                this.notificationTimeout = setTimeout(() => {
                    this.notificationVisible = false;
                }, 6000);
            },
            async confirmImport() {
                if (!this.canImport || !this.fileToImport) return;

                this.isImporting = true;
                this.validationError = null;

                const formData = new FormData();
                formData.append('file', this.fileToImport);
                formData.append('import_type', this.importType);

                const importUrl = '{% url "owner-import-execute" %}';

                 try {
                    const response = await fetch(importUrl, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': this.csrfToken },
                        body: formData
                    });
                    const data = await response.json();

                    if (response.ok && data.success) {
                        let message = `Successfully imported ${data.imported_count} new owners.`;
                        if (data.skipped_count > 0) {
                            message += ` Skipped ${data.skipped_count} duplicate owners.`;
                        }
                        this.showNotification(message, 'success');
                        this.closeModal();
                    } else {
                        let errorMsg = data.error || 'An error occurred during import.';
                        if (data.imported_count !== undefined && data.skipped_count !== undefined) {
                             errorMsg = `Import finished with errors. Imported: ${data.imported_count}. Skipped: ${data.skipped_count}. Errors:\n${data.error}`;
                        }
                        this.validationError = data.error || 'Import failed.';
                        this.showNotification(errorMsg, 'error');
                    }
                } catch (error) {
                     console.error("Import request failed:", error);
                     const errorMsg = 'An error occurred connecting to the server during import.';
                     this.validationError = errorMsg;
                     this.showNotification(errorMsg, 'error');
                } finally {
                    this.isImporting = false;
                }
            }
        }
    });
    manageApp.mount('#manage-app');
</script>
{% endblock scripts %} 